# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Cloud Build configuration for PR validation
# Triggers on pull request events to main branch

steps:
  # Step 1: Install dependencies
  - name: 'python:3.12-slim'
    id: install-dependencies
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        set -e
        echo "Installing uv and project dependencies..."
        pip install uv==0.8.13
        uv sync --locked

  # Step 2: Run linting with Ruff
  - name: 'python:3.12-slim'
    id: lint-ruff
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        set -e
        echo "Running Ruff linter..."
        pip install uv==0.8.13
        uv sync --locked --extra lint
        uv run ruff check app/ tests/ --output-format=github || true
        uv run ruff format app/ tests/ --check --diff

  # Step 3: Run type checking with mypy
  - name: 'python:3.12-slim'
    id: type-check
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        set -e
        echo "Running mypy type checker..."
        pip install uv==0.8.13
        uv sync --locked --extra lint
        uv run mypy app/ --config-file pyproject.toml || true

  # Step 4: Run codespell
  - name: 'python:3.12-slim'
    id: spell-check
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        set -e
        echo "Running codespell..."
        pip install uv==0.8.13
        uv sync --locked --extra lint
        uv run codespell app/ tests/ docs/ || true

  # Step 5: Run unit tests
  - name: 'python:3.12-slim'
    id: unit-tests
    entrypoint: /bin/bash
    env:
      - 'PROJECT_ID=$PROJECT_ID'
      - 'REGION=${_REGION}'
    args:
      - '-c'
      - |
        set -e
        echo "Running unit tests..."
        pip install uv==0.8.13
        uv sync --locked
        uv run pytest tests/unit -v --cov=app --cov-report=xml --cov-report=term

  # Step 6: Run integration tests
  - name: 'python:3.12-slim'
    id: integration-tests
    entrypoint: /bin/bash
    env:
      - 'PROJECT_ID=$PROJECT_ID'
      - 'REGION=${_REGION}'
    args:
      - '-c'
      - |
        set -e
        echo "Running integration tests..."
        pip install uv==0.8.13
        uv sync --locked
        uv run pytest tests/integration -v --maxfail=5

  # Step 7: Security scan with Safety
  - name: 'python:3.12-slim'
    id: security-scan
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        set -e
        echo "Running security scan..."
        pip install uv==0.8.13
        uv pip install safety
        uv run safety check --json || true
    allowFailure: true

  # Step 8: Terraform validation
  - name: 'hashicorp/terraform:1.9'
    id: terraform-validate
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        set -e
        cd deployment/terraform
        echo "Checking Terraform formatting..."
        terraform fmt -check -recursive || true
        echo "Initializing Terraform..."
        terraform init -backend=false
        echo "Validating Terraform configuration..."
        terraform validate

  # Step 9: Generate test report
  - name: 'gcr.io/cloud-builders/gcloud'
    id: test-report
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        echo "========================================="
        echo "PR Validation Summary"
        echo "========================================="
        echo "Commit: $COMMIT_SHA"
        echo "Branch: $BRANCH_NAME"
        echo ""
        echo "All checks completed!"
        echo "========================================="

# Logs bucket for storing build logs
logsBucket: 'gs://${PROJECT_ID}-${_PROJECT_NAME}-logs'

# Build options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  substitutionOption: 'ALLOW_LOOSE'
  dynamicSubstitutions: true

# Substitutions
substitutions:
  _REGION: 'us-central1'
  _PROJECT_NAME: 'mapachev1'

# Timeout
timeout: 1800s  # 30 minutes
