# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: PR Validation

on:
  pull_request:
    branches:
      - main
    paths:
      - 'app/**'
      - 'data_ingestion/**'
      - 'tests/**'
      - 'deployment/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/**'

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install uv
        run: |
          pip install uv==0.8.13

      - name: Install dependencies with lint extras
        run: |
          uv sync --locked --extra lint

      - name: Run Ruff linter
        run: |
          uv run ruff check app/ tests/ --output-format=github
        continue-on-error: true

      - name: Run Ruff formatter
        run: |
          uv run ruff format app/ tests/ --check --diff

      - name: Run mypy type checking
        run: |
          uv run mypy app/ --config-file pyproject.toml
        continue-on-error: true

      - name: Run codespell
        run: |
          uv run codespell app/ tests/ docs/
        continue-on-error: true

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.WIF_POOL_ID }}/providers/${{ secrets.WIF_PROVIDER_ID }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'
          create_credentials_file: true
          project_id: ${{ vars.CICD_PROJECT_ID }}

      - name: Install uv and dependencies
        run: |
          pip install uv==0.8.13
          uv sync --locked

      - name: Run unit tests
        run: |
          uv run pytest tests/unit -v --cov=app --cov-report=xml --cov-report=term
        env:
          PROJECT_ID: ${{ vars.CICD_PROJECT_ID }}
          REGION: ${{ vars.REGION }}

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-pr
        continue-on-error: true

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.WIF_POOL_ID }}/providers/${{ secrets.WIF_PROVIDER_ID }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'
          create_credentials_file: true
          project_id: ${{ vars.CICD_PROJECT_ID }}

      - name: Install uv and dependencies
        run: |
          pip install uv==0.8.13
          uv sync --locked

      - name: Run integration tests
        run: |
          uv run pytest tests/integration -v --maxfail=5
        env:
          PROJECT_ID: ${{ vars.CICD_PROJECT_ID }}
          REGION: ${{ vars.REGION }}

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv==0.8.13

      - name: Check for known vulnerabilities
        run: |
          uv pip install safety
          uv run safety check --json || true
        continue-on-error: true

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
        continue-on-error: true

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Terraform Format Check
        run: |
          cd deployment/terraform
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: |
          cd deployment/terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd deployment/terraform
          terraform validate

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-integration, security-scan, terraform-validate]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Generate PR Summary
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'Lint', result: '${{ needs.lint.result }}' },
              { name: 'Unit Tests', result: '${{ needs.test-unit.result }}' },
              { name: 'Integration Tests', result: '${{ needs.test-integration.result }}' },
              { name: 'Security Scan', result: '${{ needs.security-scan.result }}' },
              { name: 'Terraform Validation', result: '${{ needs.terraform-validate.result }}' }
            ];

            const emoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'cancelled': 'üö´',
              'skipped': '‚è≠Ô∏è'
            };

            let summary = '## PR Validation Results\n\n';
            summary += '| Check | Status |\n';
            summary += '|-------|--------|\n';

            for (const job of jobs) {
              const icon = emoji[job.result] || '‚ùì';
              summary += `| ${job.name} | ${icon} ${job.result} |\n`;
            }

            summary += '\n---\n';
            summary += `**Commit:** ${context.sha.substring(0, 7)}\n`;
            summary += `**PR:** #${context.issue.number}\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
